<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>手写promise | 张与时の岛</title><meta name="description" content="手写promise"><meta name="keywords" content="es6"><meta name="author" content="narcissus"><meta name="copyright" content="narcissus"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://yoursite.com/2021/04/03/%E6%89%8B%E5%86%99promise/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="手写promise"><meta name="twitter:description" content="手写promise"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/archive.jpg"><meta property="og:type" content="article"><meta property="og:title" content="手写promise"><meta property="og:url" content="http://yoursite.com/2021/04/03/%E6%89%8B%E5%86%99promise/"><meta property="og:site_name" content="张与时の岛"><meta property="og:description" content="手写promise"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/archive.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="next" title="奖学金管理系统数据库设计" href="http://yoursite.com/2021/04/01/%E5%A5%96%E5%AD%A6%E9%87%91%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'false',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false
  
}</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">张与时の岛</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">12</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">9</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">5</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#%E7%94%A8%E7%B1%BB%E7%9A%84%E6%96%B9%E6%B3%95%E6%9D%A5%E5%86%99promise"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">用类的方法来写promise</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#%E5%8D%95%E5%90%91%E4%BB%A5%E5%8F%8A%E5%BC%82%E5%B8%B8"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">单向以及异常</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#then"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">then</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#then%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">then捕获异常</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#promise%E5%BC%82%E6%AD%A5%E9%82%A3%E4%B9%88-then%E5%B0%B1%E4%BC%9A%E6%8F%90%E5%89%8D%E6%89%A7%E8%A1%8C"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">promise异步那么.then就会提前执行</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#%E5%87%86%E5%A4%87%E7%8A%B6%E6%80%81%E5%BC%82%E5%B8%B8%E9%94%99%E8%AF%AF%E6%8D%95%E8%8E%B7"><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">准备状态异常错误捕获</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#%E6%9B%B4%E6%94%B9%E8%B0%83%E7%94%A8promise%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91%E9%A1%BA%E5%BA%8F"><span class="toc_mobile_items-number">7.</span> <span class="toc_mobile_items-text">更改调用promise执行逻辑顺序</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#then%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E6%8E%A5%E5%8F%97%E5%89%8D%E8%80%85%E5%8F%82%E6%95%B0"><span class="toc_mobile_items-number">8.</span> <span class="toc_mobile_items-text">then链式调用接受前者参数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#%E6%96%B0%E5%A2%9E%E9%93%BE%E5%BC%8Fpromise%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc_mobile_items-number">9.</span> <span class="toc_mobile_items-text">新增链式promise异常处理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#then%E7%9A%84%E7%A9%BF%E9%80%8F"><span class="toc_mobile_items-number">10.</span> <span class="toc_mobile_items-text">then的穿透</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#then-return-promise%E5%A4%84%E7%90%86"><span class="toc_mobile_items-number">11.</span> <span class="toc_mobile_items-text">then return promise处理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#%E4%BB%A3%E7%A0%81%E5%86%97%E4%BD%99%E4%BC%98%E5%8C%96"><span class="toc_mobile_items-number">12.</span> <span class="toc_mobile_items-text">代码冗余优化</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#promise%E4%B8%8D%E5%85%81%E8%AE%B8return%E8%87%AA%E5%B7%B1"><span class="toc_mobile_items-number">13.</span> <span class="toc_mobile_items-text">promise不允许return自己</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#reject%E4%B8%8Eresolve%E7%9A%84%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="toc_mobile_items-number">14.</span> <span class="toc_mobile_items-text">reject与resolve的静态方法</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#promise-all"><span class="toc_mobile_items-number">15.</span> <span class="toc_mobile_items-text">promise.all()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#promise-race"><span class="toc_mobile_items-number">16.</span> <span class="toc_mobile_items-text">promise.race()</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc_mobile_items-number"></span> <span class="toc_mobile_items-text">完整代码</span></a></div></div><div id="body-wrap"><div id="web_bg"></div><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E7%B1%BB%E7%9A%84%E6%96%B9%E6%B3%95%E6%9D%A5%E5%86%99promise"><span class="toc-number">1.</span> <span class="toc-text">用类的方法来写promise</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E5%90%91%E4%BB%A5%E5%8F%8A%E5%BC%82%E5%B8%B8"><span class="toc-number">2.</span> <span class="toc-text">单向以及异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#then"><span class="toc-number">3.</span> <span class="toc-text">then</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#then%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8"><span class="toc-number">4.</span> <span class="toc-text">then捕获异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#promise%E5%BC%82%E6%AD%A5%E9%82%A3%E4%B9%88-then%E5%B0%B1%E4%BC%9A%E6%8F%90%E5%89%8D%E6%89%A7%E8%A1%8C"><span class="toc-number">5.</span> <span class="toc-text">promise异步那么.then就会提前执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%8A%B6%E6%80%81%E5%BC%82%E5%B8%B8%E9%94%99%E8%AF%AF%E6%8D%95%E8%8E%B7"><span class="toc-number">6.</span> <span class="toc-text">准备状态异常错误捕获</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%94%B9%E8%B0%83%E7%94%A8promise%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91%E9%A1%BA%E5%BA%8F"><span class="toc-number">7.</span> <span class="toc-text">更改调用promise执行逻辑顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#then%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E6%8E%A5%E5%8F%97%E5%89%8D%E8%80%85%E5%8F%82%E6%95%B0"><span class="toc-number">8.</span> <span class="toc-text">then链式调用接受前者参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E9%93%BE%E5%BC%8Fpromise%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text">新增链式promise异常处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#then%E7%9A%84%E7%A9%BF%E9%80%8F"><span class="toc-number">10.</span> <span class="toc-text">then的穿透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#then-return-promise%E5%A4%84%E7%90%86"><span class="toc-number">11.</span> <span class="toc-text">then return promise处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%86%97%E4%BD%99%E4%BC%98%E5%8C%96"><span class="toc-number">12.</span> <span class="toc-text">代码冗余优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#promise%E4%B8%8D%E5%85%81%E8%AE%B8return%E8%87%AA%E5%B7%B1"><span class="toc-number">13.</span> <span class="toc-text">promise不允许return自己</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reject%E4%B8%8Eresolve%E7%9A%84%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="toc-number">14.</span> <span class="toc-text">reject与resolve的静态方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#promise-all"><span class="toc-number">15.</span> <span class="toc-text">promise.all()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#promise-race"><span class="toc-number">16.</span> <span class="toc-text">promise.race()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number"></span> <span class="toc-text">完整代码</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/archive.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">手写promise</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2021-04-03<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2021-04-03</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/JavaScript/">JavaScript</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2.7k</span><span class="post-meta__separator">|</span><span>阅读时长: 12 分钟</span><span class="post-meta__separator">|</span><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h2 id="用类的方法来写promise"><a href="#用类的方法来写promise" class="headerlink" title="用类的方法来写promise"></a>用类的方法来写promise</h2><p>声明HD.js</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HD</span></span>{</span><br><span class="line"><span class="comment">//三种状态，pending-&gt;fulfilled,pending-&gt;rejected</span></span><br><span class="line"><span class="comment">//过度-&gt;成功，过渡-&gt;失败</span></span><br><span class="line">  <span class="keyword">static</span> PENDING=<span class="string">'pending'</span></span><br><span class="line">  <span class="keyword">static</span> FULFILLED=<span class="string">'fulfilled'</span></span><br><span class="line">  <span class="keyword">static</span> REJECTED=<span class="string">'rejected'</span></span><br><span class="line">  <span class="comment">//构造函数，状态和传的值，以及改变状态的执行器</span></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">executor</span>)</span>{</span><br><span class="line">    <span class="built_in">this</span>.status=HD.PENDING</span><br><span class="line">    <span class="built_in">this</span>.value=<span class="literal">null</span></span><br><span class="line">    <span class="comment">// 此bind()是在调用的时候改变this的指向到类，不然执行上下文调用的是window对象</span></span><br><span class="line">    executor(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>),<span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>))</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 修改成功时候的值和状态</span></span><br><span class="line">  <span class="function"><span class="title">resolve</span>(<span class="params">value</span>)</span>{</span><br><span class="line">    <span class="comment">// console.log(this);</span></span><br><span class="line">    <span class="built_in">this</span>.status=HD.FULFILLED</span><br><span class="line">    <span class="built_in">this</span>.value=value</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 修改失败时候的值和状态</span></span><br><span class="line">  <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span>{</span><br><span class="line">    <span class="comment">// console.log(this);</span></span><br><span class="line">    <span class="built_in">this</span>.status=HD.REJECTED</span><br><span class="line">    <span class="built_in">this</span>.value=reason</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>调用1.html</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p=<span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">  <span class="comment">// 如果在这里修改value的值与状态是不符合规范的，因为promise是不可逆的</span></span><br><span class="line">  <span class="comment">// resolve('解决')</span></span><br><span class="line">  reject(<span class="string">'拒绝'</span>)</span><br><span class="line">})</span><br><span class="line"><span class="built_in">console</span>.log(p);</span><br></pre></td></tr></tbody></table></figure>
<h2 id="单向以及异常"><a href="#单向以及异常" class="headerlink" title="单向以及异常"></a>单向以及异常</h2><p>使resolve与reject调用之后不可更改HD.js</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">resolve</span>(<span class="params">value</span>)</span>{</span><br><span class="line">  <span class="comment">// 只有在为pending的状态下才可以调用</span></span><br><span class="line">  <span class="comment">// 意思为只能调用一次</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">    <span class="built_in">this</span>.status=HD.FULFILLED</span><br><span class="line">    <span class="built_in">this</span>.value=value</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span>{</span><br><span class="line">  <span class="comment">// console.log(this);</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">    <span class="built_in">this</span>.status=HD.REJECTED</span><br><span class="line">    <span class="built_in">this</span>.value=reason</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>捕获异常HD.js</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> {</span><br><span class="line">  executor(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>),<span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>))</span><br><span class="line">} <span class="keyword">catch</span> (error) {</span><br><span class="line">  <span class="built_in">this</span>.reject(error)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="then"><a href="#then" class="headerlink" title="then"></a>then</h2><p>HD.js</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">then</span>(<span class="params">onFulfilled,onRejected</span>)</span>{</span><br><span class="line">  <span class="comment">// 获取reject状态改变之后的值</span></span><br><span class="line">  <span class="comment">// 成功才调</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.FULFILLED){</span><br><span class="line">    onFulfilled(<span class="built_in">this</span>.value)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.REJECTED){</span><br><span class="line">    onRejected(<span class="built_in">this</span>.value)</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>拒绝的时候成功调用也不会报错</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果成功不为一个函数，那么定义成一个函数</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> onFulfilled!==<span class="string">'function'</span>){</span><br><span class="line">  onFulfilled=<span class="function">()=&gt;</span>{}</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 如果失败不为一个函数，那么定义成一个函数</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> onRejected!==<span class="string">'function'</span>){</span><br><span class="line">  onRejected=<span class="function">()=&gt;</span>{}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><img alt="调用reject会使then成功的地方报错" data-src="https://img-blog.csdnimg.cn/20210403174453854.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Zvcm1hdHRvcg==,size_16,color_FFFFFF,t_70" class="lozad"></p>
<h2 id="then捕获异常"><a href="#then捕获异常" class="headerlink" title="then捕获异常"></a>then捕获异常</h2><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.FULFILLED){</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="comment">// console.log('成功');</span></span><br><span class="line">    onFulfilled(<span class="built_in">this</span>.value)</span><br><span class="line">  } <span class="keyword">catch</span> (error) {</span><br><span class="line">    <span class="comment">// console.log('出错');</span></span><br><span class="line">    onRejected(error)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.REJECTED){</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="comment">// console.log('成功出错');</span></span><br><span class="line">    onRejected(<span class="built_in">this</span>.value)</span><br><span class="line">  } <span class="keyword">catch</span> (error) {</span><br><span class="line">    <span class="comment">// console.log('出错');</span></span><br><span class="line">    onRejected(error)</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="promise异步那么-then就会提前执行"><a href="#promise异步那么-then就会提前执行" class="headerlink" title="promise异步那么.then就会提前执行"></a>promise异步那么.then就会提前执行</h2><p>此时如果是promise异步，那么.then就会直接执行，.then中的内容就会获取不到异步中的状态</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造函数中定义一个数组,放将要执行的函数</span></span><br><span class="line"><span class="built_in">this</span>.callbacks=[];</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .then中，如果处于pending状态,那么不执行.then里边的函数,把函数压入callback数组中</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">  <span class="built_in">this</span>.callbacks.push({</span><br><span class="line">    onFulfilled,</span><br><span class="line">    onRejected</span><br><span class="line">  })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// resolve()</span></span><br><span class="line"><span class="comment">// 如果执行过resolve,那么调用.then成功函数,把值传过去</span></span><br><span class="line"><span class="built_in">this</span>.callbacks.map(<span class="function"><span class="params">callback</span>=&gt;</span>{</span><br><span class="line">  callback.onRejected(reason)</span><br><span class="line">})</span><br><span class="line"><span class="comment">// ------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// reject()</span></span><br><span class="line"><span class="comment">// 如果执行过reject,那么调用.then成功函数,把值传过去</span></span><br><span class="line"><span class="built_in">this</span>.callbacks.map(<span class="function"><span class="params">callback</span>=&gt;</span>{</span><br><span class="line">  callback.onRejected(reason)</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>
<h2 id="准备状态异常错误捕获"><a href="#准备状态异常错误捕获" class="headerlink" title="准备状态异常错误捕获"></a>准备状态异常错误捕获</h2><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果处于pending状态,那么不执行.then里边的函数,把函数压入callback数组中</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">      <span class="built_in">this</span>.callbacks.push({</span><br><span class="line">        <span class="comment">// 对象属性</span></span><br><span class="line">        onFulfilled:<span class="function"><span class="params">value</span>=&gt;</span>{</span><br><span class="line">          <span class="comment">// 执行的函数</span></span><br><span class="line">          <span class="keyword">try</span> {</span><br><span class="line">            onFulfilled(value);</span><br><span class="line">          } <span class="keyword">catch</span> (error) {</span><br><span class="line">            onRejected(error)</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        onRejected:<span class="function"><span class="params">value</span>=&gt;</span>{</span><br><span class="line">          <span class="comment">// 执行的函数</span></span><br><span class="line">          <span class="keyword">try</span> {</span><br><span class="line">            onRejected(value);</span><br><span class="line">          } <span class="keyword">catch</span> (error) {</span><br><span class="line">            onRejected(error)</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">      })</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>
<h2 id="更改调用promise执行逻辑顺序"><a href="#更改调用promise执行逻辑顺序" class="headerlink" title="更改调用promise执行逻辑顺序"></a>更改调用promise执行逻辑顺序</h2><p>当resolve中的函数异步的时候，调用方式是函数外部，异步中的函数，异步结果放在下一次的then中执行（先执行异步中的非resolve和reject）,因此我们需要在调用resolve/reject的时候使用异步。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">resolve</span>(<span class="params">value</span>)</span>{</span><br><span class="line">  <span class="comment">// console.log(this);</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">    <span class="built_in">this</span>.status=HD.FULFILLED</span><br><span class="line">    <span class="built_in">this</span>.value=value</span><br><span class="line">    <span class="comment">// 使用异步来改变逻辑顺序</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="comment">// 如果执行过resolve,那么调用.then成功函数,把值传过去</span></span><br><span class="line">      <span class="built_in">this</span>.callbacks.map(<span class="function"><span class="params">callback</span>=&gt;</span>{</span><br><span class="line">        callback.onFulfilled(value)</span><br><span class="line">      })</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span>{</span><br><span class="line">  <span class="comment">// console.log(this);</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">    <span class="built_in">this</span>.status=HD.REJECTED</span><br><span class="line">    <span class="built_in">this</span>.value=reason</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="comment">// 如果执行过reject,那么调用.then成功函数,把值传过去</span></span><br><span class="line">      <span class="built_in">this</span>.callbacks.map(<span class="function"><span class="params">callback</span>=&gt;</span>{</span><br><span class="line">        callback.onRejected(reason)</span><br><span class="line">      }) </span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="then链式调用接受前者参数"><a href="#then链式调用接受前者参数" class="headerlink" title="then链式调用接受前者参数"></a>then链式调用接受前者参数</h2><p><img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20210403183824550.png" class="lozad"><br>return promise<br>当前无法调用多次then,以及then的返回值</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// then的最后</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line"> <span class="comment">// 其中包括then的所有操作</span></span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">then</span>(<span class="params">onFulfilled,onRejected</span>)</span>{</span><br><span class="line">  <span class="comment">// 如果成功不为一个函数，那么定义成一个函数</span></span><br><span class="line">  <span class="comment">// if(typeof onFulfilled!=='funciton'){</span></span><br><span class="line">  <span class="comment">//   onFulfilled=()=&gt;{}</span></span><br><span class="line">  <span class="comment">// }</span></span><br><span class="line">  <span class="comment">// // 如果失败不为一个函数，那么定义成一个函数</span></span><br><span class="line">  <span class="comment">// if(typeof onRejected!=='funciton'){</span></span><br><span class="line">  <span class="comment">//   onRejected=()=&gt;{}</span></span><br><span class="line">  <span class="comment">// }</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">        <span class="comment">// 如果处于pending状态,那么不执行.then里边的函数,把函数压入callback数组中</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">      <span class="built_in">this</span>.callbacks.push({</span><br><span class="line">        <span class="comment">// 对象属性</span></span><br><span class="line">        onFulfilled:<span class="function"><span class="params">value</span>=&gt;</span>{</span><br><span class="line">          <span class="comment">// 执行的函数</span></span><br><span class="line">          <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">let</span> result=onFulfilled(value)</span><br><span class="line">            <span class="comment">// 改变状态</span></span><br><span class="line">            resolve(result)</span><br><span class="line">            <span class="comment">// onFulfilled(value);</span></span><br><span class="line">          } <span class="keyword">catch</span> (error) {</span><br><span class="line">            onRejected(error)</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        onRejected:<span class="function"><span class="params">value</span>=&gt;</span>{</span><br><span class="line">          <span class="comment">// 执行的函数</span></span><br><span class="line">          <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// onRejected(value);</span></span><br><span class="line">            <span class="keyword">let</span> result=onRejected(value)</span><br><span class="line">            reject(result)</span><br><span class="line">          } <span class="keyword">catch</span> (error) {</span><br><span class="line">            onRejected(error)</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">      })</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 获取reject状态改变之后的值</span></span><br><span class="line">    <span class="comment">// 成功才调</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.FULFILLED){</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">          <span class="comment">// console.log('成功');</span></span><br><span class="line">          <span class="comment">// 获取成功之后的返回值</span></span><br><span class="line">          <span class="keyword">let</span> result=onFulfilled(<span class="built_in">this</span>.value)</span><br><span class="line">          <span class="comment">// 改变状态</span></span><br><span class="line">          resolve(result)</span><br><span class="line">        } <span class="keyword">catch</span> (error) {</span><br><span class="line">          <span class="comment">// console.log('出错');</span></span><br><span class="line">          onRejected(<span class="string">'出错咯'</span>+error)</span><br><span class="line">        } </span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.REJECTED){</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">          <span class="keyword">try</span> {</span><br><span class="line">          <span class="comment">// console.log('成功出错');</span></span><br><span class="line">          <span class="keyword">let</span> result=onRejected(<span class="built_in">this</span>.value)</span><br><span class="line">          reject(result)</span><br><span class="line">        } <span class="keyword">catch</span> (error) {</span><br><span class="line">          <span class="comment">// console.log('出错');</span></span><br><span class="line">          onRejected(error)</span><br><span class="line">        }</span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line">  })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="新增链式promise异常处理"><a href="#新增链式promise异常处理" class="headerlink" title="新增链式promise异常处理"></a>新增链式promise异常处理</h2><p>在上边的基础上直接调用reject而不是onRejected(error)</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reject(error)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="then的穿透"><a href="#then的穿透" class="headerlink" title="then的穿透"></a>then的穿透</h2><p>此时中间调用空的.then()就不会把值传递到下边的then</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果成功不为一个函数，那么定义成一个函数</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> onFulfilled!==<span class="string">'function'</span>){</span><br><span class="line">  onFulfilled=<span class="function">()=&gt;</span><span class="built_in">this</span>.value</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 如果失败不为一个函数，那么定义成一个函数</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> onRejected!==<span class="string">'function'</span>){</span><br><span class="line">  onRejected=<span class="function">()=&gt;</span><span class="built_in">this</span>.value</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="then-return-promise处理"><a href="#then-return-promise处理" class="headerlink" title="then return promise处理"></a>then return promise处理</h2><p>当返回的值为promise对象时，进行判断</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.FULFILLED){</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">// console.log('成功');</span></span><br><span class="line">      <span class="comment">// 获取成功之后的返回值</span></span><br><span class="line">      <span class="keyword">let</span> result=onFulfilled(<span class="built_in">this</span>.value)</span><br><span class="line">      <span class="comment">// 改变状态</span></span><br><span class="line">      <span class="comment">// resolve(result)</span></span><br><span class="line">      <span class="comment">// 判断接受的是对象还是普通的字符串</span></span><br><span class="line">      <span class="keyword">if</span>(result <span class="keyword">instanceof</span> HD){</span><br><span class="line">        <span class="comment">//如果是promise对象,那么再次调用then来返回得到的resolve的value</span></span><br><span class="line">        result.then(resolve,reject)</span><br><span class="line">        <span class="comment">// 上述一行抵下面的所有</span></span><br><span class="line">        <span class="comment">// result.then(</span></span><br><span class="line">        <span class="comment">// value=&gt;{</span></span><br><span class="line">        <span class="comment">//   resolve(value)</span></span><br><span class="line">        <span class="comment">// },</span></span><br><span class="line">        <span class="comment">// reason=&gt;{</span></span><br><span class="line">        <span class="comment">//   reject(reason)</span></span><br><span class="line">        <span class="comment">// })</span></span><br><span class="line">      }<span class="keyword">else</span>{</span><br><span class="line">        resolve(result)</span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">      <span class="comment">// console.log('出错');</span></span><br><span class="line">      <span class="comment">// onRejected('出错咯'+error)</span></span><br><span class="line">      <span class="comment">// 当发生异常时调用reject</span></span><br><span class="line">      reject(error)</span><br><span class="line">    } </span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="代码冗余优化"><a href="#代码冗余优化" class="headerlink" title="代码冗余优化"></a>代码冗余优化</h2><p><strong>优化前</strong></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HD</span></span>{</span><br><span class="line">  <span class="keyword">static</span> PENDING=<span class="string">'pending'</span></span><br><span class="line">  <span class="keyword">static</span> FULFILLED=<span class="string">'fulfilled'</span></span><br><span class="line">  <span class="keyword">static</span> REJECTED=<span class="string">'rejected'</span></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">executor</span>)</span>{</span><br><span class="line">    <span class="built_in">this</span>.status=HD.PENDING</span><br><span class="line">    <span class="built_in">this</span>.value=<span class="literal">null</span></span><br><span class="line">    <span class="comment">// 定义一个数组,放将要执行的函数</span></span><br><span class="line">    <span class="built_in">this</span>.callbacks=[];</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      executor(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>),<span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>))</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">      <span class="built_in">this</span>.reject(error)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">resolve</span>(<span class="params">value</span>)</span>{</span><br><span class="line">    <span class="comment">// console.log(this);</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">      <span class="built_in">this</span>.status=HD.FULFILLED</span><br><span class="line">      <span class="built_in">this</span>.value=value</span><br><span class="line">      <span class="comment">// 使用异步来改变逻辑顺序</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// 如果执行过resolve,那么调用.then成功函数,把值传过去</span></span><br><span class="line">        <span class="built_in">this</span>.callbacks.map(<span class="function"><span class="params">callback</span>=&gt;</span>{</span><br><span class="line">          callback.onFulfilled(value)</span><br><span class="line">        })</span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span>{</span><br><span class="line">    <span class="comment">// console.log(this);</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">      <span class="built_in">this</span>.status=HD.REJECTED</span><br><span class="line">      <span class="built_in">this</span>.value=reason</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// 如果执行过reject,那么调用.then成功函数,把值传过去</span></span><br><span class="line">        <span class="built_in">this</span>.callbacks.map(<span class="function"><span class="params">callback</span>=&gt;</span>{</span><br><span class="line">          callback.onRejected(reason)</span><br><span class="line">        }) </span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">then</span>(<span class="params">onFulfilled,onRejected</span>)</span>{</span><br><span class="line">    <span class="comment">// 如果成功不为一个函数，那么定义成一个函数</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> onFulfilled!==<span class="string">'function'</span>){</span><br><span class="line">      onFulfilled=<span class="function">()=&gt;</span><span class="built_in">this</span>.value</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 如果失败不为一个函数，那么定义成一个函数</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> onRejected!==<span class="string">'function'</span>){</span><br><span class="line">      onRejected=<span class="function">()=&gt;</span><span class="built_in">this</span>.value</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">          <span class="comment">// 如果处于pending状态,那么不执行.then里边的函数,把函数压入callback数组中</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">        <span class="built_in">this</span>.callbacks.push({</span><br><span class="line">          <span class="comment">// 对象属性</span></span><br><span class="line">          onFulfilled:<span class="function"><span class="params">value</span>=&gt;</span>{</span><br><span class="line">            <span class="comment">// 执行的函数</span></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">              <span class="keyword">let</span> result=onFulfilled(value)</span><br><span class="line">              <span class="comment">// 改变状态</span></span><br><span class="line">              <span class="comment">// resolve(result)</span></span><br><span class="line">              <span class="keyword">if</span>(result <span class="keyword">instanceof</span> HD){</span><br><span class="line">                result.then(resolve,reject)</span><br><span class="line">              }<span class="keyword">else</span>{</span><br><span class="line">                resolve(result)</span><br><span class="line">              }</span><br><span class="line">              <span class="comment">// onFulfilled(value);</span></span><br><span class="line">            } <span class="keyword">catch</span> (error) {</span><br><span class="line">              <span class="comment">// onRejected(error)</span></span><br><span class="line">              reject(error)</span><br><span class="line">            }</span><br><span class="line">          },</span><br><span class="line">          onRejected:<span class="function"><span class="params">value</span>=&gt;</span>{</span><br><span class="line">            <span class="comment">// 执行的函数</span></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">              <span class="comment">// onRejected(value);</span></span><br><span class="line">              <span class="keyword">let</span> result=onRejected(value)</span><br><span class="line">              <span class="comment">// reject(result)</span></span><br><span class="line">              <span class="keyword">if</span>(result <span class="keyword">instanceof</span> HD){</span><br><span class="line">                result.then(resolve,reject)</span><br><span class="line">              }<span class="keyword">else</span>{</span><br><span class="line">                resolve(result)</span><br><span class="line">              }</span><br><span class="line">            } <span class="keyword">catch</span> (error) {</span><br><span class="line">              <span class="comment">// onRejected(error)</span></span><br><span class="line">              reject(error)</span><br><span class="line">            }</span><br><span class="line">          },</span><br><span class="line">        })</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">// 获取reject状态改变之后的值</span></span><br><span class="line">      <span class="comment">// 成功才调</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.FULFILLED){</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">          <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// console.log('成功');</span></span><br><span class="line">            <span class="comment">// 获取成功之后的返回值</span></span><br><span class="line">            <span class="keyword">let</span> result=onFulfilled(<span class="built_in">this</span>.value)</span><br><span class="line">            <span class="comment">// 改变状态</span></span><br><span class="line">            <span class="comment">// resolve(result)</span></span><br><span class="line">            <span class="comment">// 判断接受的是对象还是普通的字符串</span></span><br><span class="line">            <span class="keyword">if</span>(result <span class="keyword">instanceof</span> HD){</span><br><span class="line">              <span class="comment">//如果是promise对象,那么再次调用then来返回得到的resolve的value</span></span><br><span class="line">              result.then(resolve,reject)</span><br><span class="line">              <span class="comment">// 上述一行抵下面的所有</span></span><br><span class="line">              <span class="comment">// result.then(</span></span><br><span class="line">              <span class="comment">// value=&gt;{</span></span><br><span class="line">              <span class="comment">//   resolve(value)</span></span><br><span class="line">              <span class="comment">// },</span></span><br><span class="line">              <span class="comment">// reason=&gt;{</span></span><br><span class="line">              <span class="comment">//   reject(reason)</span></span><br><span class="line">              <span class="comment">// })</span></span><br><span class="line">            }<span class="keyword">else</span>{</span><br><span class="line">              resolve(result)</span><br><span class="line">            }</span><br><span class="line">          } <span class="keyword">catch</span> (error) {</span><br><span class="line">            <span class="comment">// console.log('出错');</span></span><br><span class="line">            <span class="comment">// onRejected('出错咯'+error)</span></span><br><span class="line">            <span class="comment">// 当发生异常时调用reject</span></span><br><span class="line">            reject(error)</span><br><span class="line">          } </span><br><span class="line">        });</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.REJECTED){</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// console.log('成功出错');</span></span><br><span class="line">            <span class="keyword">let</span> result=onRejected(<span class="built_in">this</span>.value)</span><br><span class="line">            <span class="comment">// reject(result)</span></span><br><span class="line">            <span class="keyword">if</span>(result <span class="keyword">instanceof</span> HD){</span><br><span class="line">              result.then(resolve,reject)</span><br><span class="line">            }<span class="keyword">else</span>{</span><br><span class="line">              resolve(result)</span><br><span class="line">            }</span><br><span class="line">          } <span class="keyword">catch</span> (error) {</span><br><span class="line">            <span class="comment">// console.log('出错');</span></span><br><span class="line">            <span class="comment">// onRejected(error)</span></span><br><span class="line">            reject(error)</span><br><span class="line">          }</span><br><span class="line">        });</span><br><span class="line">      }</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><strong>优化后</strong></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 优化代码</span></span><br><span class="line"><span class="function"><span class="title">parse</span>(<span class="params">result,resolve,reject</span>)</span>{</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">if</span>(result <span class="keyword">instanceof</span> HD){</span><br><span class="line">      result.then(resolve,reject)</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">      resolve(result)</span><br><span class="line">    }</span><br><span class="line">  } <span class="keyword">catch</span> (error) {</span><br><span class="line">    reject(error)</span><br><span class="line">  } </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用函数举例</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.FULFILLED){</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">this</span>.parse(onFulfilled(<span class="built_in">this</span>.value),resolve,reject)</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.REJECTED){</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">this</span>.parse(onRejected(<span class="built_in">this</span>.value),resolve,reject)</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="promise不允许return自己"><a href="#promise不允许return自己" class="headerlink" title="promise不允许return自己"></a>promise不允许return自己</h2><p>虽然是异步，但是不允许返回自己</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//加上promise来与result做一次比较</span></span><br><span class="line"><span class="function"><span class="title">parse</span>(<span class="params">promise,result,resolve,reject</span>)</span>{</span><br><span class="line">   <span class="keyword">if</span>(promise===result){</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Chaining cycle detected'</span>)</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">     <span class="keyword">if</span>(result <span class="keyword">instanceof</span> HD){</span><br><span class="line">       result.then(resolve,reject)</span><br><span class="line">     }<span class="keyword">else</span>{</span><br><span class="line">       resolve(result)</span><br><span class="line">     }</span><br><span class="line">   } <span class="keyword">catch</span> (error) {</span><br><span class="line">     reject(error)</span><br><span class="line">   } </span><br><span class="line"> }</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 得到promise</span></span><br><span class="line"><span class="keyword">let</span> promise= <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{}</span><br><span class="line"><span class="keyword">return</span> promise;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="reject与resolve的静态方法"><a href="#reject与resolve的静态方法" class="headerlink" title="reject与resolve的静态方法"></a>reject与resolve的静态方法</h2><p>直接调用</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试</span></span><br><span class="line"><span class="keyword">let</span> promise=<span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">  resolve(<span class="string">'解决'</span>)</span><br><span class="line">})</span><br><span class="line">HD.resolve(promise).then(<span class="function"><span class="params">value</span>=&gt;</span>{</span><br><span class="line">  <span class="built_in">console</span>.log(value);</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="title">resolve</span>(<span class="params">value</span>)</span>{</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">    <span class="keyword">if</span>(value <span class="keyword">instanceof</span> HD){</span><br><span class="line">      value.then(resolve,reject)</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">      resolve(value)</span><br><span class="line">    }</span><br><span class="line">  })</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="function"><span class="title">reject</span>(<span class="params">value</span>)</span>{</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">    reject(value)</span><br><span class="line">  })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="promise-all"><a href="#promise-all" class="headerlink" title="promise.all()"></a>promise.all()</h2><p>获取全部的promise，而且全部判断是否成功</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="title">all</span>(<span class="params">promises</span>)</span>{</span><br><span class="line">  <span class="keyword">const</span> values=[]</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">    promises.forEach((<span class="function"><span class="params">promise</span>=&gt;</span>{</span><br><span class="line">      promise.then(</span><br><span class="line">        value=&gt;{</span><br><span class="line">          values.push(value)</span><br><span class="line">          <span class="keyword">if</span>(values.length==promises.length){</span><br><span class="line">            resolve(values)</span><br><span class="line">          }</span><br><span class="line">      },<span class="function"><span class="params">reason</span>=&gt;</span>{</span><br><span class="line">          reject(reason)</span><br><span class="line">      })</span><br><span class="line">    }))</span><br><span class="line">  })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="promise-race"><a href="#promise-race" class="headerlink" title="promise.race()"></a>promise.race()</h2><p>谁快用谁</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="title">race</span>(<span class="params">promises</span>)</span>{</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">    promises.map(<span class="function"><span class="params">promise</span>=&gt;</span>{</span><br><span class="line">      promise.then(<span class="function"><span class="params">value</span>=&gt;</span>{</span><br><span class="line">        resolve(value)</span><br><span class="line">      },<span class="function"><span class="params">reason</span>=&gt;</span>{</span><br><span class="line">        reject(reason)</span><br><span class="line">      })</span><br><span class="line">    })</span><br><span class="line">  })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HD</span></span>{</span><br><span class="line">  <span class="keyword">static</span> PENDING=<span class="string">'pending'</span></span><br><span class="line">  <span class="keyword">static</span> FULFILLED=<span class="string">'fulfilled'</span></span><br><span class="line">  <span class="keyword">static</span> REJECTED=<span class="string">'rejected'</span></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">executor</span>)</span>{</span><br><span class="line">    <span class="built_in">this</span>.status=HD.PENDING</span><br><span class="line">    <span class="built_in">this</span>.value=<span class="literal">null</span></span><br><span class="line">    <span class="comment">// 定义一个数组,放将要执行的函数</span></span><br><span class="line">    <span class="built_in">this</span>.callbacks=[];</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      executor(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>),<span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>))</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">      <span class="built_in">this</span>.reject(error)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">resolve</span>(<span class="params">value</span>)</span>{</span><br><span class="line">    <span class="comment">// console.log(this);</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">      <span class="built_in">this</span>.status=HD.FULFILLED</span><br><span class="line">      <span class="built_in">this</span>.value=value</span><br><span class="line">      <span class="comment">// 使用异步来改变逻辑顺序</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// 如果执行过resolve,那么调用.then成功函数,把值传过去</span></span><br><span class="line">        <span class="built_in">this</span>.callbacks.map(<span class="function"><span class="params">callback</span>=&gt;</span>{</span><br><span class="line">          callback.onFulfilled(value)</span><br><span class="line">        })</span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span>{</span><br><span class="line">    <span class="comment">// console.log(this);</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">      <span class="built_in">this</span>.status=HD.REJECTED</span><br><span class="line">      <span class="built_in">this</span>.value=reason</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// 如果执行过reject,那么调用.then成功函数,把值传过去</span></span><br><span class="line">        <span class="built_in">this</span>.callbacks.map(<span class="function"><span class="params">callback</span>=&gt;</span>{</span><br><span class="line">          callback.onRejected(reason)</span><br><span class="line">        }) </span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">then</span>(<span class="params">onFulfilled,onRejected</span>)</span>{</span><br><span class="line">    <span class="comment">// 如果成功不为一个函数，那么定义成一个函数</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> onFulfilled!==<span class="string">'function'</span>){</span><br><span class="line">      onFulfilled=<span class="function">()=&gt;</span><span class="built_in">this</span>.value</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 如果失败不为一个函数，那么定义成一个函数</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> onRejected!==<span class="string">'function'</span>){</span><br><span class="line">      onRejected=<span class="function">()=&gt;</span><span class="built_in">this</span>.value</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">let</span> promise= <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">      <span class="comment">// 如果处于pending状态,那么不执行.then里边的函数,把函数压入callback数组中</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.PENDING){</span><br><span class="line">        <span class="built_in">this</span>.callbacks.push({</span><br><span class="line">          <span class="comment">// 对象属性</span></span><br><span class="line">          onFulfilled:<span class="function"><span class="params">value</span>=&gt;</span>{</span><br><span class="line">            <span class="built_in">this</span>.parse(promise,onFulfilled(value),resolve,reject)</span><br><span class="line">          },</span><br><span class="line">          onRejected:<span class="function"><span class="params">value</span>=&gt;</span>{</span><br><span class="line">            <span class="built_in">this</span>.parse(promise,onRejected(value),resolve,reject)</span><br><span class="line">          },</span><br><span class="line">        })</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">// 获取reject状态改变之后的值</span></span><br><span class="line">      <span class="comment">// 成功才调</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.FULFILLED){</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">          <span class="built_in">this</span>.parse(promise,onFulfilled(<span class="built_in">this</span>.value),resolve,reject)</span><br><span class="line">        });</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.status===HD.REJECTED){</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">          <span class="built_in">this</span>.parse(promise,onRejected(<span class="built_in">this</span>.value),resolve,reject)</span><br><span class="line">        });</span><br><span class="line">      }</span><br><span class="line">    })</span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 优化代码</span></span><br><span class="line">  <span class="function"><span class="title">parse</span>(<span class="params">promise,result,resolve,reject</span>)</span>{</span><br><span class="line">    <span class="keyword">if</span>(promise===result){</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Chaining cycle detected'</span>)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">if</span>(result <span class="keyword">instanceof</span> HD){</span><br><span class="line">        result.then(resolve,reject)</span><br><span class="line">      }<span class="keyword">else</span>{</span><br><span class="line">        resolve(result)</span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">      reject(error)</span><br><span class="line">    } </span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">resolve</span>(<span class="params">value</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">      <span class="keyword">if</span>(value <span class="keyword">instanceof</span> HD){</span><br><span class="line">        value.then(resolve,reject)</span><br><span class="line">      }<span class="keyword">else</span>{</span><br><span class="line">        resolve(value)</span><br><span class="line">      }</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">reject</span>(<span class="params">value</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">      reject(value)</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">all</span>(<span class="params">promises</span>)</span>{</span><br><span class="line">    <span class="keyword">const</span> values=[]</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">      promises.forEach((<span class="function"><span class="params">promise</span>=&gt;</span>{</span><br><span class="line">        promise.then(</span><br><span class="line">          value=&gt;{</span><br><span class="line">            values.push(value)</span><br><span class="line">            <span class="keyword">if</span>(values.length==promises.length){</span><br><span class="line">              resolve(values)</span><br><span class="line">            }</span><br><span class="line">        },<span class="function"><span class="params">reason</span>=&gt;</span>{</span><br><span class="line">            reject(reason)</span><br><span class="line">        })</span><br><span class="line">      }))</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">race</span>(<span class="params">promises</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HD(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">      promises.map(<span class="function"><span class="params">promise</span>=&gt;</span>{</span><br><span class="line">        promise.then(<span class="function"><span class="params">value</span>=&gt;</span>{</span><br><span class="line">          resolve(value)</span><br><span class="line">        },<span class="function"><span class="params">reason</span>=&gt;</span>{</span><br><span class="line">          reject(reason)</span><br><span class="line">        })</span><br><span class="line">      })</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.houdunren.com/Edu/site/1/front/lesson/338/show">参考视频教程：手写PROMISE核心</a></p>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">narcissus</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2021/04/03/%E6%89%8B%E5%86%99promise/">http://yoursite.com/2021/04/03/%E6%89%8B%E5%86%99promise/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">张与时の岛</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/es6/">es6    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/archive.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2021/04/01/%E5%A5%96%E5%AD%A6%E9%87%91%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1/"><img class="next_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/archive.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>奖学金管理系统数据库设计</span></div></a></div></nav></div></div><footer><div id="footer"><div class="copyright">&copy;2018 - 2021 By narcissus</div><div class="framework-info"><span>驱动 </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">简</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/nightshift.js"></script><script src="/js/baidupush.js"> </script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script></body></html>